<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>GPS Navegación App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
body { margin:0; padding:0; overflow:hidden; font-family:Arial; }
#map { position:absolute; top:0; bottom:0; width:100%; }

.controls{
    position:absolute;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    background:white;
    padding:15px;
    border-radius:15px;
    z-index:1000;
    box-shadow:0 4px 10px rgba(0,0,0,0.3);
    width:300px;
}

.controls input{
    width:100%;
    margin-bottom:8px;
    padding:8px;
}

.controls button{
    width:100%;
    padding:10px;
    background:#1e8e3e;
    color:white;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
}

.suggestions{
    background:white;
    max-height:150px;
    overflow-y:auto;
    border-radius:8px;
    margin-bottom:8px;
}

.suggestion-item{
    padding:8px;
    cursor:pointer;
    border-bottom:1px solid #eee;
}

.suggestion-item:hover{
    background:#f0f0f0;
}
</style>
</head>
<body>

<div class="controls">
    <input id="start" placeholder="Dirección inicio" autocomplete="off">
    <div id="start-suggestions" class="suggestions"></div>

    <input id="end" placeholder="Dirección destino" autocomplete="off">
    <div id="end-suggestions" class="suggestions"></div>

    <button onclick="startRoute()">Iniciar ruta</button>
    <button onclick="useMyLocation()" style="margin-bottom:8px;background:#1a73e8;">
        Usar mi ubicación
    </button>
</div>

<div id="map"></div>

<script>

const map = new maplibregl.Map({
    container: 'map',
    style: 'https://tiles.openfreemap.org/styles/liberty',
    center: [-58.3816, -34.6037],
    zoom: 14,
    pitch: 60
});

let marker;
let animationId;

// ===== DISTANCIA REAL =====
function getDistance(a, b) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;

    const dLat = toRad(b[1] - a[1]);
    const dLng = toRad(b[0] - a[0]);

    const lat1 = toRad(a[1]);
    const lat2 = toRad(b[1]);

    const x = dLng * Math.cos((lat1 + lat2) / 2);
    const y = dLat;

    return Math.sqrt(x*x + y*y) * R;
}

// ===== AUTOCOMPLETE =====
function setupAutocomplete(inputId, suggestionsId){

    const input = document.getElementById(inputId);
    const suggestionsBox = document.getElementById(suggestionsId);

    input.addEventListener("input", async function(){

        const query = input.value;

        if(query.length < 3){
            suggestionsBox.innerHTML = "";
            return;
        }

        const res = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&countrycodes=ar&limit=5&q=${encodeURIComponent(query)}`
        );

        const data = await res.json();
        suggestionsBox.innerHTML = "";

        data.forEach(place => {

            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.innerText = place.display_name;

            div.onclick = () => {
                input.value = place.display_name;
                input.dataset.lon = place.lon;
                input.dataset.lat = place.lat;
                suggestionsBox.innerHTML = "";
            };

            suggestionsBox.appendChild(div);
        });

    });
}

setupAutocomplete("start", "start-suggestions");
setupAutocomplete("end", "end-suggestions");

// ===== RUTA =====
async function startRoute(){

    if(animationId) cancelAnimationFrame(animationId);

    let start = [
        parseFloat(document.getElementById("start").dataset.lon),
        parseFloat(document.getElementById("start").dataset.lat)
    ];

    let end = [
        parseFloat(document.getElementById("end").dataset.lon),
        parseFloat(document.getElementById("end").dataset.lat)
    ];

    if(isNaN(start[0]) || isNaN(end[0])){
        alert("Elegí una dirección de la lista");
        return;
    }

    const response = await fetch(
        `https://router.project-osrm.org/route/v1/driving/` +
        `${start[0]},${start[1]};${end[0]},${end[1]}` +
        `?overview=full&geometries=geojson`
    );

    const data = await response.json();
    const route = data.routes[0].geometry.coordinates;

    if(map.getSource('route')){
        map.getSource('route').setData({
            type:'Feature',
            geometry:{ type:'LineString', coordinates:route }
        });
    } else {
        map.addSource('route',{
            type:'geojson',
            data:{
                type:'Feature',
                geometry:{ type:'LineString', coordinates:route }
            }
        });

        map.addLayer({
            id:'route-line',
            type:'line',
            source:'route',
            paint:{
                'line-color':'#7a3cff',
                'line-width':8
            }
        });
    }

    if(marker) marker.remove();

    const el = document.createElement('div');
    el.innerHTML = `
    <svg width="50" height="50" viewBox="0 0 60 60">
      <circle cx="30" cy="30" r="18" fill="#1a73e8" opacity="0.25"/>
      <polygon points="30,6 46,46 30,38 14,46"
               fill="#1a73e8"
               stroke="white"
               stroke-width="3"
               stroke-linejoin="round"/>
    </svg>
    `;

    marker = new maplibregl.Marker({
        element: el,
        anchor: "center"
    })
    .setLngLat(route[0])
    .addTo(map);

    let distances = [0];
    let totalDistance = 0;

    for (let i = 1; i < route.length; i++) {
        totalDistance += getDistance(route[i-1], route[i]);
        distances.push(totalDistance);
    }

    let traveled = 0;
    let speed = 15; // metros por segundo (~54 km/h)
    let lastTime = null;

    function animate(timestamp){

        if(!lastTime) lastTime = timestamp;

        const delta = (timestamp - lastTime) / 1000;
        lastTime = timestamp;

        traveled += speed * delta;

        if(traveled < totalDistance){

            let i = 1;
            while(distances[i] < traveled) i++;

            const start = route[i-1];
            const end = route[i];

            const segmentDist = distances[i] - distances[i-1];
            const progress =
                (traveled - distances[i-1]) / segmentDist;

            const lng = start[0] + (end[0] - start[0]) * progress;
            const lat = start[1] + (end[1] - start[1]) * progress;

            const dx = end[0] - start[0];
            const dy = end[1] - start[1];
            const bearing = Math.atan2(dx, dy) * (180 / Math.PI);

            marker.setLngLat([lng, lat]);

            map.easeTo({
                center:[lng, lat],
                bearing:bearing,
                pitch:65,
                duration: 50
            });

            animationId = requestAnimationFrame(animate);
        }
    }

    animationId = requestAnimationFrame(animate);
}

// ===== UBICACIÓN =====
function useMyLocation(){

    if(!navigator.geolocation){
        alert("Tu navegador no soporta geolocalización");
        return;
    }

    navigator.geolocation.getCurrentPosition(function(position){

        const lng = position.coords.longitude;
        const lat = position.coords.latitude;

        map.flyTo({
            center: [lng, lat],
            zoom: 17,
            pitch: 60,
            speed: 0.8
        });

        const startInput = document.getElementById("start");
        startInput.value = "Mi ubicación";
        startInput.dataset.lon = lng;
        startInput.dataset.lat = lat;
    });
}

</script>
</body>
</html>
