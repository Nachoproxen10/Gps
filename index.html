<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>GPS Navegaci贸n App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
body { margin:0; padding:0; overflow:hidden; font-family:Arial; }
#map { position:absolute; top:0; bottom:0; width:100%; }

.controls{
    position:absolute;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    background:white;
    padding:15px;
    border-radius:15px;
    z-index:1000;
    box-shadow:0 4px 10px rgba(0,0,0,0.3);
    width:300px;
}

.controls input{
    width:100%;
    margin-bottom:8px;
    padding:8px;
}

.controls button{
    width:100%;
    padding:10px;
    background:#1e8e3e;
    color:white;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
}
    
    .suggestions{
    background:white;
    max-height:150px;
    overflow-y:auto;
    border-radius:8px;
    margin-bottom:8px;
}

.suggestion-item{
    padding:8px;
    cursor:pointer;
    border-bottom:1px solid #eee;
}

.suggestion-item:hover{
    background:#f0f0f0;
}
</style>
</head>
<body>

<div class="controls">
    <input id="start" placeholder="Direcci贸n inicio" autocomplete="off">
    <div id="start-suggestions" class="suggestions"></div>

    <input id="end" placeholder="Direcci贸n destino" autocomplete="off">
    <div id="end-suggestions" class="suggestions"></div>

    <button onclick="startRoute()">Iniciar ruta</button>
    
    <button onclick="useMyLocation()" style="margin-bottom:8px;background:#1a73e8;">
Usar mi ubicaci贸n
</button>
</div>

<div id="map"></div>

<script>

const map = new maplibregl.Map({
    container: 'map',
    style: 'https://tiles.openfreemap.org/styles/liberty',
    center: [-58.3816, -34.6037],
    zoom: 14,
    pitch: 60
});

let marker;
let animationId;

async function geocode(address){
    const res = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
    );
    const data = await res.json();
    return [parseFloat(data[0].lon), parseFloat(data[0].lat)];
}
    
    function setupAutocomplete(inputId, suggestionsId){

    const input = document.getElementById(inputId);
    const suggestionsBox = document.getElementById(suggestionsId);

    input.addEventListener("input", async function(){

        const query = input.value;

        if(query.length < 3){
            suggestionsBox.innerHTML = "";
            return;
        }

        const res = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&countrycodes=ar&limit=5&q=${encodeURIComponent(query)}`
        );

        const data = await res.json();

        suggestionsBox.innerHTML = "";

        data.forEach(place => {

            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.innerText = place.display_name;

            div.onclick = () => {
                input.value = place.display_name;
                input.dataset.lon = place.lon;
                input.dataset.lat = place.lat;
                suggestionsBox.innerHTML = "";
            };

            suggestionsBox.appendChild(div);
        });

    });
}

setupAutocomplete("start", "start-suggestions");
setupAutocomplete("end", "end-suggestions");

async function startRoute(){

    if(animationId) cancelAnimationFrame(animationId);

    const startAddress = document.getElementById("start").value;
    const endAddress = document.getElementById("end").value;

    let start = [
    parseFloat(document.getElementById("start").dataset.lon),
    parseFloat(document.getElementById("start").dataset.lat)
];

let end = [
    parseFloat(document.getElementById("end").dataset.lon),
    parseFloat(document.getElementById("end").dataset.lat)
];

if(!start[0] || !end[0]){
    alert("Eleg铆 una direcci贸n de la lista");
    return;
}

    const response = await fetch(
        `https://router.project-osrm.org/route/v1/driving/` +
        `${start[0]},${start[1]};${end[0]},${end[1]}` +
        `?overview=full&geometries=geojson`
    );

    const data = await response.json();
    const route = data.routes[0].geometry.coordinates;

    if(map.getSource('route')){
        map.getSource('route').setData({
            type:'Feature',
            geometry:{ type:'LineString', coordinates:route }
        });
    } else {
        map.addSource('route',{
            type:'geojson',
            data:{
                type:'Feature',
                geometry:{ type:'LineString', coordinates:route }
            }
        });

        map.addLayer({
            id:'route-line',
            type:'line',
            source:'route',
            paint:{
                'line-color':'#7a3cff',
                'line-width':8
            }
        });
    }

    if(marker) marker.remove();
// Flecha estilo navegaci贸n real
const el = document.createElement('div');
el.style.width = "60px";
el.style.height = "60px";
el.style.display = "flex";
el.style.alignItems = "center";
el.style.justifyContent = "center";

el.innerHTML = `
<svg id="arrow" width="50" height="50" viewBox="0 0 60 60">
  <circle cx="30" cy="30" r="18" fill="#1a73e8" opacity="0.25"/>
  <polygon points="30,6 46,46 30,38 14,46"
           fill="#1a73e8"
           stroke="white"
           stroke-width="3"
           stroke-linejoin="round"/>
</svg>
`;

marker = new maplibregl.Marker({
    element: el,
    anchor: "center"
})
.setLngLat(route[0])
.addTo(map);

const arrow = el.querySelector("#arrow");

 let index = 0;
let speed = 0.00003; // velocidad real (m谩s chico = m谩s lento)
let lastTime = null;

function animate(timestamp){

    if(!lastTime) lastTime = timestamp;

    const delta = timestamp - lastTime; // tiempo entre frames
    lastTime = timestamp;

    if(index < route.length - 1){

        const baseIndex = Math.floor(index);
        const nextIndex = baseIndex + 1;

        const start = route[baseIndex];
        const end = route[nextIndex];

        const progress = index - baseIndex;

        const lng = start[0] + (end[0] - start[0]) * progress;
        const lat = start[1] + (end[1] - start[1]) * progress;

        const dx = end[0] - start[0];
        const dy = end[1] - start[1];
        const bearing = Math.atan2(dx, dy) * (180 / Math.PI);

        marker.setLngLat([lng, lat]);

        map.easeTo({
            center:[lng, lat],
            bearing:bearing,
            pitch:65,
            duration: 50
        });

        index += speed * delta; //  ahora depende del tiempo real

        animationId = requestAnimationFrame(animate);
    }
}

animationId = requestAnimationFrame(animate);

    
 function useMyLocation(){

    if(!navigator.geolocation){
        alert("Tu navegador no soporta geolocalizaci贸n");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        function(position){

            const lng = position.coords.longitude;
            const lat = position.coords.latitude;

            // Centrar mapa
            map.flyTo({
                center: [lng, lat],
                zoom: 17,
                pitch: 60,
                speed: 0.8
            });

            // Crear o mover marcador azul
            if(marker){
                marker.setLngLat([lng, lat]);
            } else {
                marker = new maplibregl.Marker({ color: "#1a73e8" })
                    .setLngLat([lng, lat])
                    .addTo(map);
            }

            // Tambi茅n ponerlo autom谩ticamente como inicio
            const startInput = document.getElementById("start");
            startInput.value = "Mi ubicaci贸n";
            startInput.dataset.lon = lng;
            startInput.dataset.lat = lat;
        },
        function(error){
            alert("No se pudo obtener tu ubicaci贸n. Revis谩 permisos.");
        },
        {
            enableHighAccuracy: true
        }
    );
 }   

</script>
</body>
</html>
